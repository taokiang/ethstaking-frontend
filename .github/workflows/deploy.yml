name: Deploy DApp to Pinata

on:
  push:
    branches: ["main"]

jobs:
  build-and-upload:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Setup Node.js
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      # 3. Install dependencies
      - name: Install dependencies
        run: npm install

      # 4. Build Vue + Vite project
      - name: Build project
        run: npm run build

      # 5. Upload dist folder to Pinata using v3 API
      - name: Upload to Pinata
        id: pinata
        env:
          PINATA_JWT: ${{ secrets.PINATA_JWT }}
        run: |
          DIST_PATH=dist
          echo "Uploading dist folder to Pinata..."
          # 用 curl 上传整个 dist 目录
          RESPONSE=$(curl -s -X POST "https://api.pinata.cloud/pinning/pinFileToIPFS" \
            -H "Authorization: Bearer $PINATA_JWT" \
            -F "file=@${DIST_PATH};type=application/x-directory" \
            -F 'pinataMetadata={"name":"my-dapp"}' \
            -F 'pinataOptions={"cidVersion":1}')
          
          # 输出返回的 JSON
          echo "Response from Pinata: $RESPONSE"

          # 解析 CID 并保存为输出
          CID=$(echo $RESPONSE | jq -r '.data.cid')
          echo "DApp CID: $CID"
          echo "::set-output name=cid::$CID"

      # 6. 输出访问 URL
      - name: Show access URL
        run: |
          echo "Your DApp is available at: https://${{ steps.pinata.outputs.cid }}.ipfs.dweb.link"
