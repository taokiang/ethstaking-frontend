# .github/workflows/deploy.yml
name: Deploy to IPFS via Pinata

on:
  push:
    branches: [ main ]        # 只在 main 分支有新提交时触发
  workflow_dispatch:          # 支持手动点按钮触发

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout代码
        uses: actions/checkout@v4

      - name: 安装 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'                  # 自动缓存 node_modules，第二次超快

      - name: 安装依赖
        run: npm install

      - name: 构建 Vue 项目
        run: npm run build:test

      - name: 安装 Pinata SDK
        run: npm install pinata@latest

      - name: 上传 dist 到 Pinata（使用 JWT）
        env:
          PINATA_JWT: ${{ secrets.PINATA_JWT }}
        run: |
          node - <<'EOF'
          import { PinataSDK } from "pinata";
          import fs from "fs";
          import path from "path";

          const pinata = new PinataSDK({
            pinataJwt: process.env.PINATA_JWT,
            pinataGateway: "gateway.mypinata.cloud"
          });

          async function getFiles(dir, base = "") {
            let results = [];
            const list = fs.readdirSync(dir);
            for (const file of list) {
              const fullPath = path.join(dir, file);
              if (fs.statSync(fullPath).isDirectory()) {
                results = results.concat(await getFiles(fullPath, path.join(base, file)));
              } else {
                const content = fs.readFileSync(fullPath);
                const relative = base ? path.join(base, file) : file;
                results.push(new File([content], relative));
              }
            }
            return results;
          }

          const files = await getFiles("dist");
          const upload = await pinata.upload.public
            .fileArray(files)
            .name(`ethstaking-frontend - ${{ github.sha }}`)
            .keyvalues({ commit: "${{ github.sha }}", actor: "${{ github.actor }}" });

          const cid = upload.cid;
          const url = `https://${cid}.ipfs.dweb.link`;

          console.log("IPFS CID:", cid);
          console.log("永久访问地址:", url);
          EOF